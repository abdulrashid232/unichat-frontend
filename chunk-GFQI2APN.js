import{a as j}from"./chunk-GJUVR4XO.js";import{C as b,Qa as m,a as n,b as a,g as c,j as h,k as S,o,r as l,u as p,w as u,z as g}from"./chunk-EMO2IYOT.js";var v=class d{constructor(e,t){this.http=e;this.toastService=t;this.loadChatHistory().subscribe()}API_URL="https://unichat-backend.onrender.com/api/chat";SESSIONS_URL="https://unichat-backend.onrender.com/api/sessions";currentSessionSubject=new c(null);currentSession$=this.currentSessionSubject.asObservable();sessionsSubject=new c([]);sessions$=this.sessionsSubject.asObservable();loadingSubject=new c(!1);loading$=this.loadingSubject.asObservable();errorSubject=new c(null);error$=this.errorSubject.asObservable();sendNewMessage(e,t){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.post(`${this.API_URL}/message`,{message:e,topic:t}).pipe(u(s=>{let{session:r}=s.data;r?.id&&this.getSessionById(r.id).subscribe()}),l(()=>this.loadingSubject.next(!1)),o(this.handleErrorWithLoading()))}sendMessageToSession(e,t,s){if(!e)return h(()=>new Error("Session ID is required"));this.loadingSubject.next(!0),this.errorSubject.next(null);let r=this.currentSessionSubject.value;if(r&&r.id===e){let i={id:`temp-${Date.now()}`,text:t,sender:"user",timestamp:new Date,conversationId:e,topic:s??r.topic},f=[...r.messages||[],i];this.currentSessionSubject.next(a(n({},r),{messages:f}))}return this.http.post(`${this.API_URL}/sessions/${e}/message`,{message:t,topic:s}).pipe(p(i=>this.getSessionById(e)),o(i=>(r&&this.currentSessionSubject.next(r),this.handleErrorWithLoading()(i))),l(()=>this.loadingSubject.next(!1)))}loadChatHistory(){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.get(`${this.API_URL}/history`).pipe(S(e=>{if(!e.success)throw new Error(e.error??"Failed to load chat history");return e.data}),u(e=>{let t=(e.sessions||[]).map(s=>a(n({},s),{createdAt:new Date(s.createdAt),updatedAt:new Date(s.updatedAt),lastMessageAt:new Date(s.lastMessageAt),messages:(s.messages||[]).map(r=>a(n({},r),{timestamp:new Date(r.timestamp)}))}));this.sessionsSubject.next(t)}),l(()=>this.loadingSubject.next(!1)),o(this.handleErrorWithLoading()))}getSessionById(e){return e?(this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.get(`${this.API_URL}/sessions/${e}`).pipe(S(t=>{if(!t.success)throw new Error(t.error??"Failed to load session");let s=t.data;return a(n({},s),{createdAt:new Date(s.createdAt),updatedAt:new Date(s.updatedAt),lastMessageAt:new Date(s.lastMessageAt),messages:(s.messages??[]).map(i=>a(n({},i),{timestamp:new Date(i.timestamp)}))})}),u(t=>{this.currentSessionSubject.next(t);let r=this.sessionsSubject.value.map(i=>i.id===t.id?a(n({},i),{title:t.title,lastMessageAt:t.lastMessageAt}):i);this.sessionsSubject.next(r)}),l(()=>this.loadingSubject.next(!1)),o(this.handleErrorWithLoading()))):h(()=>new Error("Session ID is required"))}deleteSession(e){return e?(this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.delete(`${this.SESSIONS_URL}/${e}`).pipe(u(()=>{let s=this.sessionsSubject.value.filter(r=>r.id!==e);this.sessionsSubject.next(s),this.currentSessionSubject.value?.id===e&&this.currentSessionSubject.next(null)}),l(()=>this.loadingSubject.next(!1)),o(this.handleErrorWithLoading()))):h(()=>new Error("Session ID is required"))}clearChatHistory(){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.delete(`${this.API_URL}/history`).pipe(u(()=>{this.sessionsSubject.next([]),this.currentSessionSubject.next(null)}),l(()=>this.loadingSubject.next(!1)),o(this.handleErrorWithLoading()))}handleErrorWithLoading(){return e=>(this.loadingSubject.next(!1),this.handleError(e))}handleError(e){let t="An unknown error occurred";return e.error instanceof ErrorEvent?t=`Error: ${e.error.message}`:e.error?.message?t=e.error.message:e.message&&(t=e.message),this.errorSubject.next(t),this.toastService.error(t),console.error("Chat service error:",t),h(()=>new Error(t))}static \u0275fac=function(t){return new(t||d)(b(m),b(j))};static \u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})};export{v as a};
